<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>One Last Image API</title>
<style>
:root {
    /* æ›´åŠ æ´»æ³¼çš„ç»¿è‰²ç³» */
    --color-primary: #66a9b5; /* Lime Green */
    --color-primary-light: #f7f7f7; /* Light Green */
    --color-primary-dark: #22718b; /* Forest Green */
    
    /* æ¸©æš–çš„ç±³è‰²/æµ…ç°è‰²èƒŒæ™¯ */
    --color-bg: #FDF9F3; /* Creamy White */
    --color-card: #FFFFFF;
    --color-text: #2F4F4F; /* Dark Slate Gray */
    --color-text-light: #696969; /* Dim Gray */
    --color-border: #E0E0E0; /* Light Gray */
    
    --color-success: #c5b54a; /* Bootstrap Green */
    --color-danger: #DC3545; /* Bootstrap Red */
    
    --shadow: 0 6px 16px -2px rgba(0, 0, 0, 0.1), 0 3px 9px -1px rgba(0, 0, 0, 0.06);
    --shadow-light: 0 2px 5px 0 rgba(0, 0, 0, 0.08), 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    
    --radius: 12px;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
    margin: 0;
    background-color: var(--color-bg);
    color: var(--color-text);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 40px 20px;
    min-height: 100vh;
    box-sizing: border-box;
}

.container {
    width: 100%;
    max-width: 1200px;
}

header {
    text-align: center;
    padding-bottom: 25px;
    margin-bottom: 35px;
    border-bottom: 1px solid var(--color-border);
}

header h1 {
    color: var(--color-primary-dark); /* æ ‡é¢˜ä½¿ç”¨æ·±ä¸»é¢˜è‰² */
    font-weight: 700;
    font-size: 2.2em;
    margin: 0 0 4px;
}

header p {
    font-size: 1.05em;
    color: var(--color-text-light);
    margin: 5px 0 0;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
}

main {
    display: grid;
    grid-template-columns: 1fr;
    gap: 30px;
}

.result-area {
    display: flex;
    flex-direction: column;
    gap: 30px;
}

.image-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 25px;
}

.image-box {
    background: var(--color-card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    border: 1px solid var(--color-border);
    padding: 20px;
    display: flex;
    flex-direction: column;
    min-height: 300px;
}

.image-box h3 {
    margin: 0 0 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--color-border);
    color: var(--color-text);
    font-weight: 600;
    font-size: 1.1em;
}

.image-wrapper {
    flex-grow: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--color-bg);
    border-radius: 8px;
    overflow: hidden;
    position: relative;
    border: 1px solid var(--color-border);
}

.image-wrapper img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    display: none;
}

.image-wrapper .placeholder {
    color: var(--color-text-light);
    padding: 20px;
    text-align: center;
    font-size: 0.95em;
}

#loading,
#error-message {
    display: none;
    padding: 15px 20px;
    border-radius: 8px;
    font-weight: 500;
    margin-top: -10px;
    border: 1px solid;
}

#loading {
    background: var(--color-primary-light);
    color: var(--color-primary-dark);
    border-color: #BEE0FF;
    text-align: center;
}

#error-message {
    background: #FFF1F2;
    color: var(--color-danger);
    border-color: #FFD6D9;
}

.controls {
    display: grid;
    grid-template-columns: 380px 1fr;
    gap: 30px;
}

.card {
    background: var(--color-card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    border: 1px solid var(--color-border);
    padding: 28px;
}

.card h2 {
    margin: 0 0 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--color-border);
    font-size: 1.2em;
    font-weight: 600;
}

.file-upload-label {
    display: block;
    width: 100%;
    padding: 25px 0;
    background: var(--color-bg);
    color: var(--color-text-light);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    text-align: center;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    box-sizing: border-box;
}

.file-upload-label:hover {
    background: var(--color-card);
    border-color: var(--color-primary);
    color: var(--color-primary);
    box-shadow: 0 0 0 3px var(--color-primary-light);
}

#image-input {
    display: none;
}

#file-name {
    display: block;
    text-align: center;
    color: var(--color-text-light);
    margin-top: 12px;
    font-size: 0.9em;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

#generate-button {
    width: 100%;
    padding: 14px;
    font-size: 1.05em;
    font-weight: 600;
    background-color: var(--color-primary);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 20px;
    box-shadow: var(--shadow-light);
}

#generate-button:hover:not(:disabled) {
    background-color: var(--color-primary-dark);
    transform: translateY(-1px);
    box-shadow: var(--shadow);
}

#generate-button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
}

.config-group {
    margin-bottom: 20px;
}

.config-group:last-child {
    margin-bottom: 0;
}

.config-group h3 {
    font-size: 0.9em;
    font-weight: 600;
    color: var(--color-text-light);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 25px 0 15px;
    padding-top: 20px;
    border-top: 1px dashed var(--color-border);
}

.config-group>label {
    font-weight: 600;
    font-size: 0.95em;
    color: var(--color-text-light);
    display: block;
    margin-bottom: 8px;
}

select {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    padding: 12px 14px;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    background-color: var(--color-card);
    font-size: 0.95em;
    cursor: pointer;
    transition: all 0.2s;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
    background-position: right 0.7rem center;
    background-repeat: no-repeat;
    background-size: 1.25em 1.25em;
    padding-right: 2.5rem;
}

select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px var(--color-primary-light);
}

.switch-group {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    padding-top: 5px;
}

.ui-switch {
    display: inline-flex;
    align-items: center;
    cursor: pointer;
    padding: 5px;
    background-color: var(--color-card);
    border-radius: 30px;
    border: 1px solid var(--color-border);
    transition: all 0.2s;
    -webkit-user-select: none;
    -moz-user-select: none;
    user-select: none;
}

.ui-switch .text {
    margin-left: 8px;
    padding-right: 6px;
    font-weight: 500;
    font-size: 0.95em;
    color: var(--color-text-light);
    transition: color 0.2s;
}

.ui-switch:hover {
    background-color: var(--color-bg);
    border-color: #D1D5DB;
}

.ui-switch input {
    opacity: 0;
    width: 0;
    height: 0;
    position: absolute;
}

.ui-switch .slider {
    position: relative;
    display: inline-block;
    width: 38px;
    height: 22px;
    background-color: var(--color-border);
    transition: 0.3s;
    border-radius: 22px;
}

.ui-switch .slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.ui-switch input:checked+.slider {
    background-color: var(--color-primary);
}

.ui-switch input:checked+.slider:before {
    transform: translateX(16px);
}

.ui-switch input:checked+.slider+.text {
    color: var(--color-primary-dark);
    font-weight: 600;
}

.ui-switch[data-disabled="true"],
.range-slider[data-disabled="true"] {
    opacity: 0.5;
    pointer-events: none;
}

.range-slider {
    display: flex;
    flex-direction: column;
    margin-bottom: 18px;
}

.range-slider:last-child {
    margin-bottom: 0;
}

.range-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.range-row label {
    font-weight: 500;
    font-size: 0.95em;
    color: var(--color-text);
}

.range-row .value-display {
    font-weight: 500;
    color: var(--color-primary-dark);
    font-size: 0.9em;
    min-width: 30px;
    text-align: right;
    background-color: var(--color-primary-light);
    padding: 3px 8px;
    border-radius: 6px;
}

input[type="range"] {
    width: 100%;
    -webkit-appearance: none;
    appearance: none;
    height: 5px;
    background: var(--color-border);
    border-radius: 3px;
    outline: none;
    cursor: pointer;
    transition: opacity 0.2s;
}

input[type="range"]:hover {
    opacity: 0.85;
}

input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    background: var(--color-primary);
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
}

input[type="range"]::-moz-range-thumb {
    width: 12px;
    height: 12px;
    background: var(--color-primary);
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
}

footer {
    text-align: center;
    margin-top: 40px;
    color: var(--color-text-light);
    font-size: 0.9em;
}

footer a {
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 500;
}

footer a:hover {
    text-decoration: underline;
}

@media (max-width: 900px) {
    main {
        grid-template-columns: 1fr;
    }

    .controls {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 600px) {
    body {
        padding: 20px 15px;
    }

    main,
    .result-area {
        gap: 20px;
    }

    .controls {
        gap: 20px;
    }

    header {
        margin-bottom: 25px;
    }

    .image-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }

    .card,
    .image-box {
        padding: 20px;
    }
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 0 0 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--color-border);
}
.card .card-header h2 {
    margin: 0;
    padding: 0;
    border: none;
    font-size: 1.2em;
    font-weight: 600;
    text-align: left;
    margin-right: 20px;
}

.button-secondary {
    background-color: var(--color-card);
    color: var(--color-text);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 0.9em;
    font-weight: 500;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s;
    flex-shrink: 0;
    box-shadow: var(--shadow-light);
}

.button-secondary:hover {
    background-color: var(--color-bg);
    border-color: #D1D5DB;
    color: var(--color-text);
    box-shadow: none;
}


.api-code-block {
    background-color: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: 10px 10px 10px 16px;
    display: inline-flex;
    margin-top: 25px;
    max-width: 100%;
    justify-content: space-between;
    align-items: center;
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
    box-sizing: border-box;
}

.api-code-block pre {
    margin: 0;
    padding: 0;
    overflow-x: auto;
    white-space: pre-wrap;
    word-break: break-all;
    color: var(--color-text);
    line-height: 1.5;
    text-align: left;
}

.api-code-block code {
    font-size: 1em;
}

.api-code-block button {
    background-color: var(--color-card);
    color: var(--color-text-light);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 0.9em;
    font-weight: 500;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s;
    margin-left: 15px;
    flex-shrink: 0;
}

.api-code-block button:hover {
    background-color: #F8F9FA;
    color: var(--color-text);
    border-color: #D1D5DB;
}

.api-code-block button.copied {
    background-color: var(--color-success);
    border-color: #059669;
    color: white;
}
</style>
</head>

<body>
    <div class="container">
        <header>
            Â  Â  Â  Â  Â  Â 
            <h1>ğŸ§¸ One Last Image API</h1> Â  Â  Â  Â  Â  Â 
            <p>API éƒ¨ç½²æˆåŠŸï¼</p> Â  Â  Â  Â  Â  Â 
            <p>æœ¬é¡µé¢å¯ç›´æ¥è°ƒç”¨ API åœ¨çº¿ä½¿ç”¨</p>

            Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
            <div class="api-code-block">
                Â  Â  Â  Â  Â  Â  Â  Â 
                <pre><code id="api-url-display">...</code></pre>
                Â  Â  Â  Â  Â  Â  Â  Â 
                <button type="button" id="copy-api-url" title="å¤åˆ¶ API URL">
                    å¤åˆ¶
                </button>
                Â  Â  Â  Â  Â  Â 
            </div>
            Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
        </header>

        <main>
            <div class="result-area">
                <div id="loading">
                    æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™... (Vercel å†·å¯åŠ¨å¯èƒ½éœ€è¦ 10-20s)
                </div>
                <div id="error-message"></div>

                <div class="image-grid">
                    <div class="image-box">
                        <h3>åŸå§‹å›¾ç‰‡</h3>
                        <div class="image-wrapper">
                            <img id="original-image" alt="Original" />
                            <span class="placeholder" id="original-placeholder">ä¸Šä¼ å›¾ç‰‡ååœ¨æ­¤æ˜¾ç¤º</span>
                        </div>
                    </div>
                    <div class="image-box">
                        <h3>ç”Ÿæˆç»“æœ</h3>
                        <div class="image-wrapper">
                            <img id="result-image" alt="Result" />
                            <span class="placeholder" id="result-placeholder">ç‚¹å‡»ç”Ÿæˆååœ¨æ­¤æ˜¾ç¤º</span>
                        </div>
                    </div>
                </div>
            </div>

            <form class="controls" id="api-form">
                <div class="card">
                    <h2>æ“ä½œ</h2>
                    <input type="file" id="image-input" accept="image/png, image/jpeg, image/webp" required />
                    <label for="image-input" class="file-upload-label">é€‰æ‹©å›¾ç‰‡</label>
                    <span id="file-name">æœªé€‰æ‹©æ–‡ä»¶</span>

                    <button type="submit" id="generate-button">ç”Ÿæˆ</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        Â  <h2>é…ç½®</h2>
                        Â  Â <button type="button" id="reset-config-button"
                            class="button-secondary">é‡ç½®ä¸ºé»˜è®¤</button>
                        Â  Â  Â  Â  Â  Â  </div>

                    <div class="config-group">
                        <label for="config-convoluteName">é£æ ¼æ•ˆæœ</label>
                        <select id="config-convoluteName" name="convoluteName">
                            <option value="ç²¾ç»†">ç²¾ç»†</option>
                            <option value="ä¸€èˆ¬" selected>ä¸€èˆ¬ (é»˜è®¤)</option>
                            <option value="ç¨ç²—">ç¨ç²—</option>
                            <option value="è¶…ç²—">è¶…ç²—</option>
                            <option value="æç²—">æç²—</option>
                            <option value="æµ®é›•">æµ®é›•</option>
                        </select>
                    </div>

                    <div class="config-group">
                        <div class="switch-group">
                            <label class="ui-switch">
                                <input type="checkbox" id="config-denoise" name="denoise" checked />
                                <span class="slider"></span>
                                <span class="text">é™å™ª</span>
                            </label>
                            <label class="ui-switch">
                                <input type="checkbox" id="config-convolute1Diff" name="convolute1Diff" checked />
                                <span class="slider"></span>
                                <span class="text">å·ç§¯å·®å¼‚</span>
                            </label>
                            <label class="ui-switch">
                                <input type="checkbox" id="config-kuma" name="kuma" checked />
                                <span class="slider"></span>
                                <span class="text">"Kiss" æ¸å˜</span>
                            </label>
                            <label class="ui-switch">
                                <input type="checkbox" id="config-shade" name="shade" checked />
                                <span class="slider"></span>
                                <span class="text">å¯ç”¨é˜´å½±</span>
                            </label>
                            <label class="ui-switch">
                                <input type="checkbox" id="config-watermark" name="watermark" checked />
                                <span class="slider"></span>
                                <span class="text">æ˜¾ç¤ºæ°´å°</span>
                            </label>
                            <label class="ui-switch" id="hajimei-control" data-depends-on="config-watermark">
                                <input type="checkbox" id="config-hajimei" name="hajimei" />
                                <span class="slider"></span>
                                <span class="text">å½©è‰²æ°´å°</span>
                            </label>
                        </div>
                    </div>

                    <div class="config-group">
                        <h3>å‚æ•°è°ƒæ•´</h3>
                        <div class="range-slider" id="shade-limit-control" data-depends-on="config-shade">
                            <div class="range-row">
                                <label for="config-shadeLimit">é˜´å½±é˜ˆå€¼</label>
                                <span class="value-display" id="shadeLimit-val">108</span>
                            </div>
                            <input type="range" id="config-shadeLimit" name="shadeLimit" min="0" max="255"
                                value="108" />
                        </div>
                        <div class="range-slider" id="shade-light-control" data-depends-on="config-shade">
                            <div class="range-row">
                                <label for="config-shadeLight">é˜´å½±å¼ºåº¦</label>
                                <span class="value-display" id="shadeLight-val">80</span>
                            </div>
                            <input type="range" id="config-shadeLight" name="shadeLight" min="0" max="255" value="80" />
                        </div>
                        <div class="range-slider">
                            <div class="range-row">
                                <label for="config-light">äº®åº¦è°ƒæ•´</label>
                                <span class="value-display" id="light-val">0</span>
                            </div>
                            <input type="range" id="config-light" name="light" min="-100" max="100" value="0" />
                        </div>
                        <div class="range-slider">
                            <div class="range-row">
                                <label for="config-lightCut">äº®éƒ¨åˆ‡å‰²</label>
                                <span class="value-display" id="lightCut-val">128</span>
                            </div>
                            <input type="range" id="config-lightCut" name="lightCut" min="0" max="255" value="128" />
                        </div>
                        <div class="range-slider">
                            <div class="range-row">
                                <label for="config-darkCut">æš—éƒ¨åˆ‡å‰²</label>
                                <span class="value-display" id="darkCut-val">118</span>
                            </div>
                            <input type="range" id="config-darkCut" name="darkCut" min="0" max="255" value="118" />
                        </div>
                        <div class="range-slider">
                            <div class="range-row">
                                <label for="config-zoom">ç¼©æ”¾æ¯”ä¾‹</label>
                                <span class="value-display" id="zoom-val">1.0</span>
                            </div>
                            <input type="range" id="config-zoom" name="zoom" min="0.5" max="3" value="1" step="0.1" />
                        </div>
                    </div>
                </div>
            </form>
        </main>

        <footer>
            <p>
                API éƒ¨ç½²åœ¨ Vercelã€‚
                <a href="https://github.com/timetetng/one-last-image-api" target="_blank" rel="noopener noreferrer">æŸ¥çœ‹
                    GitHub ä»“åº“</a>
                è·å–å®Œæ•´æ–‡æ¡£ã€‚
            </p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const apiUrlElement = document.getElementById('api-url-display');
            const copyButton = document.getElementById('copy-api-url');

            if (apiUrlElement && copyButton) {
                // 1. åŠ¨æ€ç”Ÿæˆ URL
                const dynamicApiUrl = window.location.origin + '/api/generate';

                // 2. å°† URL è®¾ç½®åˆ° code å…ƒç´ ä¸­
                apiUrlElement.textContent = dynamicApiUrl;

                // 3. ä¸ºå¤åˆ¶æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
                copyButton.addEventListener('click', () => {
                    navigator.clipboard.writeText(dynamicApiUrl).then(() => {
                        // å¤åˆ¶æˆåŠŸåé¦ˆ
                        const originalText = copyButton.textContent;
                        copyButton.textContent = 'å·²å¤åˆ¶!';
                        copyButton.classList.add('copied');

                        // 2ç§’åæ¢å¤
                        setTimeout(() => {
                            copyButton.textContent = originalText;
                            copyButton.classList.remove('copied');
                        }, 2000);

                    }).catch(err => {
                        // å¤åˆ¶å¤±è´¥åé¦ˆ
                        console.error('æ— æ³•å¤åˆ¶åˆ°å‰ªè´´æ¿: ', err);
                        copyButton.textContent = 'å¤±è´¥';
                        setTimeout(() => {
                            copyButton.textContent = 'å¤åˆ¶';
                        }, 2000);
                    });
                });
            }
            const resetButton = document.getElementById('reset-config-button');

            if (resetButton) {
                // è¾…åŠ©å‡½æ•°ï¼šè®¾ç½®æ»‘å—å€¼å¹¶æ›´æ–°æ˜¾ç¤º
                const setSliderValue = (sliderId, displayId, value) => {
                    const slider = document.getElementById(sliderId);
                    const display = document.getElementById(displayId);
                    if (slider) {
                        slider.value = value;
                        if (display) {
                            // ä½¿ç”¨æ‚¨ç°æœ‰çš„é€»è¾‘æ¥æ ¼å¼åŒ–æ˜¾ç¤º
                            display.textContent = parseFloat(slider.value).toFixed(slider.step == '0.1' ? 1 : 0);
                        }
                    }
                };

                // é‡ç½®å‡½æ•°
                const resetConfigToDefaults = () => {
                    // ä¸‹æ‹‰èœå•
                    document.getElementById('config-convoluteName').value = 'ä¸€èˆ¬';

                    // å¼€å…³
                    document.getElementById('config-denoise').checked = true;
                    document.getElementById('config-convolute1Diff').checked = true;
                    document.getElementById('config-kuma').checked = true;
                    document.getElementById('config-shade').checked = true;
                    document.getElementById('config-watermark').checked = true;
                    document.getElementById('config-hajimei').checked = false;

                    // æ»‘å—
                    setSliderValue('config-shadeLimit', 'shadeLimit-val', '108');
                    setSliderValue('config-shadeLight', 'shadeLight-val', '80');
                    setSliderValue('config-light', 'light-val', '0');
                    setSliderValue('config-lightCut', 'lightCut-val', '128');
                    setSliderValue('config-darkCut', 'darkCut-val', '118');
                    setSliderValue('config-zoom', 'zoom-val', '1.0');

                    // é‡æ–°è§¦å‘ä¾èµ–æ£€æŸ¥ (é€šè¿‡æ‰‹åŠ¨è§¦å‘ master å¼€å…³çš„ 'change' äº‹ä»¶)
                    document.getElementById('config-shade').dispatchEvent(new Event('change'));
                    document.getElementById('config-watermark').dispatchEvent(new Event('change'));
                };

                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                resetButton.addEventListener('click', resetConfigToDefaults);
            }
            const apiForm = document.getElementById("api-form");
            const imageInput = document.getElementById("image-input");
            const fileNameDisplay = document.getElementById("file-name");
            const generateButton = document.getElementById("generate-button");

            const originalImage = document.getElementById("original-image");
            const originalPlaceholder = document.getElementById(
                "original-placeholder"
            );
            const resultImage = document.getElementById("result-image");
            const resultPlaceholder = document.getElementById("result-placeholder");

            const loadingIndicator = document.getElementById("loading");
            const errorMessage = document.getElementById("error-message");

            let originalObjectURL = null;
            let resultObjectURL = null;

            // --- åŠ¨æ€æ˜¾ç¤ºæ»‘å—å€¼ ---
            const sliders = [
                { id: "config-shadeLimit", valId: "shadeLimit-val" },
                { id: "config-shadeLight", valId: "shadeLight-val" },
                { id: "config-light", valId: "light-val" },
                { id: "config-lightCut", valId: "lightCut-val" },
                { id: "config-darkCut", valId: "darkCut-val" },
                { id: "config-zoom", valId: "zoom-val" },
            ];

            sliders.forEach((item) => {
                const slider = document.getElementById(item.id);
                const display = document.getElementById(item.valId);
                if (slider && display) {
                    slider.addEventListener("input", () => {
                        display.textContent = parseFloat(slider.value).toFixed(
                            slider.step == "0.1" ? 1 : 0
                        );
                    });
                }
            });

            // --- æ§ä»¶ä¾èµ–å…³ç³» ---
            const dependencies = [
                {
                    masterId: "config-shade",
                    slaveIds: ["shade-limit-control", "shade-light-control"],
                },
                {
                    masterId: "config-watermark",
                    slaveIds: ["hajimei-control"],
                },
            ];

            dependencies.forEach((dep) => {
                const master = document.getElementById(dep.masterId);
                if (!master) return;

                const updateSlaves = () => {
                    const isDisabled = !master.checked;
                    dep.slaveIds.forEach((slaveId) => {
                        const slave = document.getElementById(slaveId);
                        if (slave) {
                            slave.setAttribute("data-disabled", isDisabled);
                            // ç¡®ä¿å†…éƒ¨ input ä¹Ÿè¢«ç¦ç”¨
                            slave
                                .querySelectorAll("input, select")
                                .forEach((el) => (el.disabled = isDisabled));
                        }
                    });
                };

                master.addEventListener("change", updateSlaves);
                updateSlaves(); // åˆå§‹åŒ–çŠ¶æ€
            });

            // --- æ–‡ä»¶ä¸Šä¼ å¤„ç† ---
            imageInput.addEventListener("change", () => {
                if (imageInput.files && imageInput.files[0]) {
                    const file = imageInput.files[0];
                    fileNameDisplay.textContent = file.name;

                    if (originalObjectURL) URL.revokeObjectURL(originalObjectURL);

                    originalObjectURL = URL.createObjectURL(file);
                    originalImage.src = originalObjectURL;
                    originalImage.style.display = "block";
                    originalPlaceholder.style.display = "none";

                    // æ¸…ç©ºä¸Šæ¬¡ç»“æœ
                    resultImage.style.display = "none";
                    resultPlaceholder.style.display = "inline";
                    if (resultObjectURL) {
                        URL.revokeObjectURL(resultObjectURL);
                        resultObjectURL = null;
                    }
                } else {
                    fileNameDisplay.textContent = "æœªé€‰æ‹©æ–‡ä»¶";
                }
            });

            // --- è¡¨å•æäº¤ ---
            apiForm.addEventListener("submit", async (e) => {
                e.preventDefault();

                if (!imageInput.files || imageInput.files.length === 0) {
                    showError("è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡ã€‚");
                    return;
                }

                setLoading(true);

                try {
                    // 1. æ”¶é›†é…ç½®
                    const config = {};
                    const formElements = apiForm.elements;

                    // æ”¶é›†å¸ƒå°”å€¼ (Switches)
                    [
                        "shade",
                        "kuma",
                        "hajimei",
                        "watermark",
                        "convolute1Diff",
                        "denoise",
                    ].forEach((key) => {
                        const el = formElements[`config-${key}`];
                        if (el) config[key] = el.checked;
                    });

                    // æ”¶é›†æ•°å­— (Sliders)
                    [
                        "light",
                        "shadeLimit",
                        "shadeLight",
                        "lightCut",
                        "darkCut",
                    ].forEach((key) => {
                        const el = formElements[`config-${key}`];
                        if (el) config[key] = parseInt(el.value, 10);
                    });
                    const zoomEl = formElements["config-zoom"];
                    if (zoomEl) config.zoom = parseFloat(zoomEl.value);

                    // æ”¶é›†å­—ç¬¦ä¸² (Select)
                    const convoluteEl = formElements["config-convoluteName"];
                    if (convoluteEl) config.convoluteName = convoluteEl.value;

                    // 2. åˆ›å»º FormData
                    const formData = new FormData();
                    formData.append("image", imageInput.files[0]);
                    formData.append("config", JSON.stringify(config));

                    // 3. å‘é€è¯·æ±‚
                    const response = await fetch("/api/generate", {
                        method: "POST",
                        body: formData,
                    });

                    if (!response.ok) {
                        let errorDetails = `HTTP çŠ¶æ€ ${response.status}: ${response.statusText}`;
                        try {
                            const errorJson = await response.json();
                            errorDetails = errorJson.error || errorDetails;
                            if (errorJson.details) {
                                errorDetails += ` (${errorJson.details})`;
                            }
                        } catch (parseErr) { }
                        throw new Error(errorDetails);
                    }

                    // 4. æ˜¾ç¤ºç»“æœ
                    const imageBlob = await response.blob();

                    if (resultObjectURL) URL.revokeObjectURL(resultObjectURL);

                    resultObjectURL = URL.createObjectURL(imageBlob);
                    resultImage.src = resultObjectURL;
                    resultImage.style.display = "block";
                    resultPlaceholder.style.display = "none";
                } catch (err) {
                    console.error("ç”Ÿæˆå¤±è´¥:", err);
                    showError(`ç”Ÿæˆå¤±è´¥: ${err.message}`);
                } finally {
                    setLoading(false);
                }
            });

            function setLoading(isLoading) {
                loadingIndicator.style.display = isLoading ? "block" : "none";
                generateButton.disabled = isLoading;
                if (isLoading) {
                    errorMessage.style.display = "none";
                }
            }

            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = "block";
            }
        });
    </script>
</body>

</html>