<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>One Last Image API</title>
    <style>
      :root {
        --color-primary: #007aff;
        --color-primary-light: #e6f2ff;
        --color-primary-dark: #0056b3;
        --color-bg: #f4f7fa;
        --color-card: #ffffff;
        --color-text: #2c3e50;
        --color-text-light: #5a7184;
        --color-border: #e0e6ed;
        --color-success: #28a745;
        --color-danger: #dc3545;
        --shadow: 0 10px 30px -15px rgba(0, 0, 0, 0.1);
        --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.05);
        --radius: 12px;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
        margin: 0;
        background-color: var(--color-bg);
        color: var(--color-text);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        min-height: 100vh;
        box-sizing: border-box;
      }

      .container {
        width: 100%;
        max-width: 1200px;
      }

      header {
        text-align: center;
        padding-bottom: 20px;
        margin-bottom: 30px;
        border-bottom: 1px solid var(--color-border);
      }
      header h1 {
        color: var(--color-text);
        font-weight: 700;
        margin: 0;
      }
      header p {
        font-size: 1.1em;
        color: var(--color-text-light);
        margin: 5px 0 0;
      }
      main {
        display: grid;
        grid-template-columns: 1fr;
        gap: 30px;
      }

      /* --- ç»“æœåŒºåŸŸ --- */
      .result-area {
        display: flex;
        flex-direction: column;
        gap: 30px;
      }
      .image-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }
      .image-box {
        background: var(--color-card);
        border-radius: var(--radius);
        box-shadow: var(--shadow-light);
        padding: 20px;
        display: flex;
        flex-direction: column;
        min-height: 300px;
      }
      .image-box h3 {
        margin: 0 0 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--color-border);
        color: var(--color-text);
        font-weight: 600;
      }
      .image-wrapper {
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--color-bg);
        border-radius: 8px;
        overflow: hidden;
        position: relative;
      }
      .image-wrapper img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        display: none; /* é»˜è®¤éšè— */
      }
      .image-wrapper .placeholder {
        color: var(--color-text-light);
        font-style: italic;
        padding: 20px;
        text-align: center;
      }
      #loading,
      #error-message {
        display: none;
        padding: 15px 20px;
        border-radius: 8px;
        font-weight: 600;
        margin-top: -10px; /* æŠµæ¶ˆä¸€ç‚¹ gap */
      }
      #loading {
        background: var(--color-primary-light);
        color: var(--color-primary-dark);
        border: 1px solid var(--color-primary-light);
        text-align: center;
      }
      #error-message {
        background: #fff0f1;
        color: var(--color-danger);
        border: 1px solid #ffdfe2;
      }

      .controls {
        display: grid;
        grid-template-columns: 380px 1fr;
        gap: 30px;
      }
      .card {
        background: var(--color-card);
        border-radius: var(--radius);
        box-shadow: var(--shadow-light);
        padding: 25px;
      }
      .card h2 {
        margin: 0 0 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--color-border);
        font-size: 1.25em;
        font-weight: 600;
      }

      /* æ ¸å¿ƒæ“ä½œæŒ‰é’® */
      .file-upload-label {
        display: block;
        width: 100%;
        padding: 15px 0;
        background: var(--color-primary-light);
        color: var(--color-primary-dark);
        border: 2px dashed var(--color-primary);
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        box-sizing: border-box;
      }
      .file-upload-label:hover {
        background: #dbeeff;
        border-color: var(--color-primary-dark);
      }
      #image-input {
        display: none;
      }
      #file-name {
        display: block;
        text-align: center;
        color: var(--color-text-light);
        margin-top: 10px;
        font-size: 0.9em;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      #generate-button {
        width: 100%;
        padding: 15px;
        font-size: 1.1em;
        font-weight: 600;
        background-color: var(--color-primary);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s;
        margin-top: 20px;
      }
      #generate-button:hover:not(:disabled) {
        background-color: var(--color-primary-dark);
      }
      #generate-button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      /* --- å¯è§†åŒ–é…ç½® --- */
      .config-group {
        margin-bottom: 15px;
      }
      .config-group:last-child {
        margin-bottom: 0;
      }

      /* ç»„æ ‡é¢˜ (ç”¨äºæ»‘å—) */
      .config-group h3 {
        font-size: 1em;
        font-weight: 600;
        color: var(--color-text-light);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin: 20px 0 15px;
        padding-top: 15px;
        border-top: 1px dashed var(--color-border);
      }

      /* ä¸‹æ‹‰èœå• (Select) */
      .config-group > label {
        /* ç”¨äºä¸‹æ‹‰èœå•çš„ label */
        font-weight: 600;
        font-size: 0.9em;
        color: var(--color-text-light);
        display: block;
        margin-bottom: 8px;
      }
      select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--color-border);
        border-radius: 8px;
        background-color: #fcfcfc;
        font-size: 1em;
        cursor: pointer;
      }
      select:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 2px var(--color-primary-light);
      }

      /* æ–°çš„å¼€å…³ç»„ (æ°´å¹³æ’åˆ—) */
      .switch-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding-top: 5px;
      }

      .ui-switch {
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        padding: 6px 10px 6px 6px;
        background-color: var(--color-bg);
        border-radius: 20px;
        border: 1px solid var(--color-border);
        transition: all 0.2s;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }
      .ui-switch .text {
        margin-left: 8px;
        padding-right: 4px; /* å¢åŠ ä¸€ç‚¹å³è¾¹è· */
        font-weight: 500;
        font-size: 0.9em;
        color: var(--color-text-light);
        transition: color 0.2s;
      }
      .ui-switch:hover {
        background-color: #eaf0f6;
        border-color: #cdd8e4;
      }

      .ui-switch input {
        opacity: 0;
        width: 0;
        height: 0;
        position: absolute; /* éšè— input æœ¬èº« */
      }

      /* å¼€å…³çš„æ»‘å—æ ·å¼ */
      .ui-switch .slider {
        position: relative;
        display: inline-block;
        width: 38px;
        height: 22px;
        background-color: #ccc;
        transition: 0.3s;
        border-radius: 22px;
      }
      .ui-switch .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      }

      .ui-switch input:checked + .slider {
        background-color: var(--color-primary);
      }
      .ui-switch input:checked + .slider:before {
        transform: translateX(16px);
      }
      .ui-switch input:checked + .slider + .text {
        color: var(--color-text);
        font-weight: 500;
      }

      /* ä¾èµ–ç¦ç”¨æ ·å¼ */
      .ui-switch[data-disabled="true"],
      .range-slider[data-disabled="true"] {
        opacity: 0.5;
        pointer-events: none;
      }

      /* æ»‘å— (Range Slider) */
      .range-slider {
        display: flex;
        flex-direction: column;
        margin-bottom: 15px;
      }
      .range-slider:last-child {
        margin-bottom: 0;
      }
      .range-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      .range-row label {
        font-weight: 500;
        font-size: 0.95em;
      }
      .range-row .value-display {
        font-weight: 600;
        color: var(--color-primary);
        font-size: 0.9em;
        min-width: 30px;
        text-align: right;
        background-color: var(--color-primary-light);
        padding: 2px 6px;
        border-radius: 4px;
      }
      input[type="range"] {
        width: 100%;
        -webkit-appearance: none;
        appearance: none;
        height: 6px;
        background: var(--color-border);
        border-radius: 3px;
        outline: none;
        cursor: pointer;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        background: var(--color-primary);
        border-radius: 50%;
        cursor: pointer;
        border: 3px solid white;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
      }
      input[type="range"]::-moz-range-thumb {
        width: 12px; /* å‡å»è¾¹æ¡† */
        height: 12px; /* å‡å»è¾¹æ¡† */
        background: var(--color-primary);
        border-radius: 50%;
        cursor: pointer;
        border: 3px solid white;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
      }

      /* é¡µè„š */
      footer {
        text-align: center;
        margin-top: 40px;
        color: var(--color-text-light);
        font-size: 0.9em;
      }
      footer a {
        color: var(--color-primary);
        text-decoration: none;
        font-weight: 500;
      }
      footer a:hover {
        text-decoration: underline;
      }

      /* å“åº”å¼å¸ƒå±€ */
      @media (max-width: 900px) {
        main {
          grid-template-columns: 1fr;
        }
        .controls {
          grid-template-columns: 1fr;
        }
      }
      @media (max-width: 600px) {
        body {
          padding: 15px;
        }
        main,
        .result-area {
          gap: 20px;
        }
        header {
          margin-bottom: 20px;
        }
        .image-grid {
          grid-template-columns: 1fr;
          gap: 20px;
        }
        .card,
        .image-box {
          padding: 20px;
        }
      }
            .api-code-block {
            background-color: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 12px 16px;
            display: inline-flex; 
            margin-top: 20px; 
            max-width: 100%; 
            
            justify-content: space-between;
            align-items: center;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            box-sizing: border-box; 
        }
        
        .api-code-block pre {
            margin: 0;
            padding: 0;
            overflow-x: auto; /* URLå¤ªé•¿æ—¶æ»šåŠ¨ */
            white-space: pre-wrap; /* ä¼˜å…ˆæ¢è¡Œ */
            word-break: break-all; /* å¼ºåˆ¶æ–­è¯ */
            color: var(--color-text);
            line-height: 1.5;
            text-align: left; /* è¦†ç›– header çš„ text-align: center */
        }

        .api-code-block code {
            font-size: 0.95em;
        }

        .api-code-block button {
            background-color: #cfe0e7;
            color: var(--color-text-light);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.9em;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 15px; /* ä¸ URL æ–‡æœ¬éš”å¼€ */
            flex-shrink: 0; /* é˜²æ­¢æŒ‰é’®è¢«å‹ç¼© */
        }
        
        .api-code-block button:hover {
            background-color: #dce4eb;
            color: var(--color-text);
        }

        /* å¤åˆ¶æˆåŠŸåçš„åé¦ˆæ ·å¼ */
        .api-code-block button.copied {
            background-color: var(--color-success);
            border-color: var(--color-success);
            color: white;
        }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        Â  Â  Â  Â  Â  Â 
        <h1>ğŸ§¸ One Last Image API</h1>        Â  Â  Â  Â  Â  Â 
        <p>API éƒ¨ç½²æˆåŠŸï¼</p>        Â  Â  Â  Â  Â  Â 
        <p>æœ¬é¡µé¢å¯ç›´æ¥è°ƒç”¨ API åœ¨çº¿ä½¿ç”¨</p>

        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
        <div class="api-code-block">
          Â  Â  Â  Â  Â  Â  Â  Â 
          <pre><code id="api-url-display">...</code></pre>
          Â  Â  Â  Â  Â  Â  Â  Â 
          <button type="button" id="copy-api-url" title="å¤åˆ¶ API URL">
            å¤åˆ¶
          </button>
          Â  Â  Â  Â  Â  Â 
        </div>
        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
      </header>

      <main>
        <div class="result-area">
          <div id="loading">
            æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™... (Vercel å†·å¯åŠ¨å¯èƒ½éœ€è¦ 10-20s)
          </div>
          <div id="error-message"></div>

          <div class="image-grid">
            <div class="image-box">
              <h3>åŸå§‹å›¾ç‰‡</h3>
              <div class="image-wrapper">
                <img id="original-image" alt="Original" />
                <span class="placeholder" id="original-placeholder"
                  >ä¸Šä¼ å›¾ç‰‡ååœ¨æ­¤æ˜¾ç¤º</span
                >
              </div>
            </div>
            <div class="image-box">
              <h3>ç”Ÿæˆç»“æœ</h3>
              <div class="image-wrapper">
                <img id="result-image" alt="Result" />
                <span class="placeholder" id="result-placeholder"
                  >ç‚¹å‡»ç”Ÿæˆååœ¨æ­¤æ˜¾ç¤º</span
                >
              </div>
            </div>
          </div>
        </div>

        <form class="controls" id="api-form">
          <div class="card">
            <h2>1. æ“ä½œ</h2>
            <input
              type="file"
              id="image-input"
              accept="image/png, image/jpeg, image/webp"
              required
            />
            <label for="image-input" class="file-upload-label">é€‰æ‹©å›¾ç‰‡</label>
            <span id="file-name">æœªé€‰æ‹©æ–‡ä»¶</span>

            <button type="submit" id="generate-button">ç”Ÿæˆ</button>
          </div>

          <div class="card">
            <h2>2. å¯è§†åŒ–é…ç½®</h2>

            <div class="config-group">
              <label for="config-convoluteName">é£æ ¼æ•ˆæœ</label>
              <select id="config-convoluteName" name="convoluteName">
                <option value="ç²¾ç»†">ç²¾ç»†</option>
                <option value="ä¸€èˆ¬" selected>ä¸€èˆ¬ (é»˜è®¤)</option>
                <option value="ç¨ç²—">ç¨ç²—</option>
                <option value="è¶…ç²—">è¶…ç²—</option>
                <option value="æç²—">æç²—</option>
                <option value="æµ®é›•">æµ®é›•</option>
              </select>
            </div>

            <div class="config-group">
              <div class="switch-group">
                <label class="ui-switch">
                  <input
                    type="checkbox"
                    id="config-denoise"
                    name="denoise"
                    checked
                  />
                  <span class="slider"></span>
                  <span class="text">é™å™ª</span>
                </label>
                <label class="ui-switch">
                  <input
                    type="checkbox"
                    id="config-convolute1Diff"
                    name="convolute1Diff"
                    checked
                  />
                  <span class="slider"></span>
                  <span class="text">å·ç§¯å·®å¼‚</span>
                </label>
                <label class="ui-switch">
                  <input type="checkbox" id="config-kuma" name="kuma" checked />
                  <span class="slider"></span>
                  <span class="text">"Kiss" æ¸å˜</span>
                </label>
                <label class="ui-switch">
                  <input
                    type="checkbox"
                    id="config-shade"
                    name="shade"
                    checked
                  />
                  <span class="slider"></span>
                  <span class="text">å¯ç”¨é˜´å½±</span>
                </label>
                <label class="ui-switch">
                  <input
                    type="checkbox"
                    id="config-watermark"
                    name="watermark"
                    checked
                  />
                  <span class="slider"></span>
                  <span class="text">æ˜¾ç¤ºæ°´å°</span>
                </label>
                <label
                  class="ui-switch"
                  id="hajimei-control"
                  data-depends-on="config-watermark"
                >
                  <input type="checkbox" id="config-hajimei" name="hajimei" />
                  <span class="slider"></span>
                  <span class="text">å½©è‰²æ°´å°</span>
                </label>
              </div>
            </div>

            <div class="config-group">
              <h3>å‚æ•°è°ƒæ•´</h3>
              <div
                class="range-slider"
                id="shade-limit-control"
                data-depends-on="config-shade"
              >
                <div class="range-row">
                  <label for="config-shadeLimit">é˜´å½±é˜ˆå€¼</label>
                  <span class="value-display" id="shadeLimit-val">108</span>
                </div>
                <input
                  type="range"
                  id="config-shadeLimit"
                  name="shadeLimit"
                  min="0"
                  max="255"
                  value="108"
                />
              </div>
              <div
                class="range-slider"
                id="shade-light-control"
                data-depends-on="config-shade"
              >
                <div class="range-row">
                  <label for="config-shadeLight">é˜´å½±å¼ºåº¦</label>
                  <span class="value-display" id="shadeLight-val">80</span>
                </div>
                <input
                  type="range"
                  id="config-shadeLight"
                  name="shadeLight"
                  min="0"
                  max="255"
                  value="80"
                />
              </div>
              <div class="range-slider">
                <div class="range-row">
                  <label for="config-light">äº®åº¦è°ƒæ•´</label>
                  <span class="value-display" id="light-val">0</span>
                </div>
                <input
                  type="range"
                  id="config-light"
                  name="light"
                  min="-100"
                  max="100"
                  value="0"
                />
              </div>
              <div class="range-slider">
                <div class="range-row">
                  <label for="config-lightCut">äº®éƒ¨åˆ‡å‰²</label>
                  <span class="value-display" id="lightCut-val">128</span>
                </div>
                <input
                  type="range"
                  id="config-lightCut"
                  name="lightCut"
                  min="0"
                  max="255"
                  value="128"
                />
              </div>
              <div class="range-slider">
                <div class="range-row">
                  <label for="config-darkCut">æš—éƒ¨åˆ‡å‰²</label>
                  <span class="value-display" id="darkCut-val">118</span>
                </div>
                <input
                  type="range"
                  id="config-darkCut"
                  name="darkCut"
                  min="0"
                  max="255"
                  value="118"
                />
              </div>
              <div class="range-slider">
                <div class="range-row">
                  <label for="config-zoom">ç¼©æ”¾æ¯”ä¾‹</label>
                  <span class="value-display" id="zoom-val">1.0</span>
                </div>
                <input
                  type="range"
                  id="config-zoom"
                  name="zoom"
                  min="0.5"
                  max="3"
                  value="1"
                  step="0.1"
                />
              </div>
            </div>
          </div>
        </form>
      </main>

      <footer>
        <p>
          API éƒ¨ç½²åœ¨ Vercelã€‚
          <a
            href="https://github.com/timetetng/one-last-image-api"
            target="_blank"
            rel="noopener noreferrer"
            >æŸ¥çœ‹ GitHub ä»“åº“</a
          >
          è·å–å®Œæ•´æ–‡æ¡£ã€‚
        </p>
      </footer>
    </div>

    <script>
            document.addEventListener('DOMContentLoaded', () => {

            const apiUrlElement = document.getElementById('api-url-display');
            const copyButton = document.getElementById('copy-api-url');
            
            if (apiUrlElement && copyButton) {
                // 1. åŠ¨æ€ç”Ÿæˆ URL
                const dynamicApiUrl = window.location.origin + '/api/generate';
                
                // 2. å°† URL è®¾ç½®åˆ° code å…ƒç´ ä¸­
                apiUrlElement.textContent = dynamicApiUrl;
                
                // 3. ä¸ºå¤åˆ¶æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
                copyButton.addEventListener('click', () => {
                    navigator.clipboard.writeText(dynamicApiUrl).then(() => {
                        // å¤åˆ¶æˆåŠŸåé¦ˆ
                        const originalText = copyButton.textContent;
                        copyButton.textContent = 'å·²å¤åˆ¶!';
                        copyButton.classList.add('copied');
                        
                        // 2ç§’åæ¢å¤
                        setTimeout(() => {
                            copyButton.textContent = originalText;
                            copyButton.classList.remove('copied');
                        }, 2000);
                        
                    }).catch(err => {
                        // å¤åˆ¶å¤±è´¥åé¦ˆ
                        console.error('æ— æ³•å¤åˆ¶åˆ°å‰ªè´´æ¿: ', err);
                        copyButton.textContent = 'å¤±è´¥';
                        setTimeout(() => {
                            copyButton.textContent = 'å¤åˆ¶';
                        }, 2000);
                    });
                });
            }

        const apiForm = document.getElementById("api-form");
        const imageInput = document.getElementById("image-input");
        const fileNameDisplay = document.getElementById("file-name");
        const generateButton = document.getElementById("generate-button");

        const originalImage = document.getElementById("original-image");
        const originalPlaceholder = document.getElementById(
          "original-placeholder"
        );
        const resultImage = document.getElementById("result-image");
        const resultPlaceholder = document.getElementById("result-placeholder");

        const loadingIndicator = document.getElementById("loading");
        const errorMessage = document.getElementById("error-message");

        let originalObjectURL = null;
        let resultObjectURL = null;

        // --- åŠ¨æ€æ˜¾ç¤ºæ»‘å—å€¼ ---
        const sliders = [
          { id: "config-shadeLimit", valId: "shadeLimit-val" },
          { id: "config-shadeLight", valId: "shadeLight-val" },
          { id: "config-light", valId: "light-val" },
          { id: "config-lightCut", valId: "lightCut-val" },
          { id: "config-darkCut", valId: "darkCut-val" },
          { id: "config-zoom", valId: "zoom-val" },
        ];

        sliders.forEach((item) => {
          const slider = document.getElementById(item.id);
          const display = document.getElementById(item.valId);
          if (slider && display) {
            slider.addEventListener("input", () => {
              display.textContent = parseFloat(slider.value).toFixed(
                slider.step == "0.1" ? 1 : 0
              );
            });
          }
        });

        // --- æ§ä»¶ä¾èµ–å…³ç³» ---
        const dependencies = [
          {
            masterId: "config-shade",
            slaveIds: ["shade-limit-control", "shade-light-control"],
          },
          {
            masterId: "config-watermark",
            slaveIds: ["hajimei-control"],
          },
        ];

        dependencies.forEach((dep) => {
          const master = document.getElementById(dep.masterId);
          if (!master) return;

          const updateSlaves = () => {
            const isDisabled = !master.checked;
            dep.slaveIds.forEach((slaveId) => {
              const slave = document.getElementById(slaveId);
              if (slave) {
                slave.setAttribute("data-disabled", isDisabled);
                // ç¡®ä¿å†…éƒ¨ input ä¹Ÿè¢«ç¦ç”¨
                slave
                  .querySelectorAll("input, select")
                  .forEach((el) => (el.disabled = isDisabled));
              }
            });
          };

          master.addEventListener("change", updateSlaves);
          updateSlaves(); // åˆå§‹åŒ–çŠ¶æ€
        });

        // --- æ–‡ä»¶ä¸Šä¼ å¤„ç† ---
        imageInput.addEventListener("change", () => {
          if (imageInput.files && imageInput.files[0]) {
            const file = imageInput.files[0];
            fileNameDisplay.textContent = file.name;

            if (originalObjectURL) URL.revokeObjectURL(originalObjectURL);

            originalObjectURL = URL.createObjectURL(file);
            originalImage.src = originalObjectURL;
            originalImage.style.display = "block";
            originalPlaceholder.style.display = "none";

            // æ¸…ç©ºä¸Šæ¬¡ç»“æœ
            resultImage.style.display = "none";
            resultPlaceholder.style.display = "inline";
            if (resultObjectURL) {
              URL.revokeObjectURL(resultObjectURL);
              resultObjectURL = null;
            }
          } else {
            fileNameDisplay.textContent = "æœªé€‰æ‹©æ–‡ä»¶";
          }
        });

        // --- è¡¨å•æäº¤ ---
        apiForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          if (!imageInput.files || imageInput.files.length === 0) {
            showError("è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡ã€‚");
            return;
          }

          setLoading(true);

          try {
            // 1. æ”¶é›†é…ç½®
            const config = {};
            const formElements = apiForm.elements;

            // æ”¶é›†å¸ƒå°”å€¼ (Switches)
            [
              "shade",
              "kuma",
              "hajimei",
              "watermark",
              "convolute1Diff",
              "denoise",
            ].forEach((key) => {
              const el = formElements[`config-${key}`];
              if (el) config[key] = el.checked;
            });

            // æ”¶é›†æ•°å­— (Sliders)
            [
              "light",
              "shadeLimit",
              "shadeLight",
              "lightCut",
              "darkCut",
            ].forEach((key) => {
              const el = formElements[`config-${key}`];
              if (el) config[key] = parseInt(el.value, 10);
            });
            const zoomEl = formElements["config-zoom"];
            if (zoomEl) config.zoom = parseFloat(zoomEl.value);

            // æ”¶é›†å­—ç¬¦ä¸² (Select)
            const convoluteEl = formElements["config-convoluteName"];
            if (convoluteEl) config.convoluteName = convoluteEl.value;

            // 2. åˆ›å»º FormData
            const formData = new FormData();
            formData.append("image", imageInput.files[0]);
            formData.append("config", JSON.stringify(config));

            // 3. å‘é€è¯·æ±‚
            const response = await fetch("/api/generate", {
              method: "POST",
              body: formData,
            });

            if (!response.ok) {
              let errorDetails = `HTTP çŠ¶æ€ ${response.status}: ${response.statusText}`;
              try {
                const errorJson = await response.json();
                errorDetails = errorJson.error || errorDetails;
                if (errorJson.details) {
                  errorDetails += ` (${errorJson.details})`;
                }
              } catch (parseErr) {}
              throw new Error(errorDetails);
            }

            // 4. æ˜¾ç¤ºç»“æœ
            const imageBlob = await response.blob();

            if (resultObjectURL) URL.revokeObjectURL(resultObjectURL);

            resultObjectURL = URL.createObjectURL(imageBlob);
            resultImage.src = resultObjectURL;
            resultImage.style.display = "block";
            resultPlaceholder.style.display = "none";
          } catch (err) {
            console.error("ç”Ÿæˆå¤±è´¥:", err);
            showError(`ç”Ÿæˆå¤±è´¥: ${err.message}`);
          } finally {
            setLoading(false);
          }
        });

        function setLoading(isLoading) {
          loadingIndicator.style.display = isLoading ? "block" : "none";
          generateButton.disabled = isLoading;
          if (isLoading) {
            errorMessage.style.display = "none";
          }
        }

        function showError(message) {
          errorMessage.textContent = message;
          errorMessage.style.display = "block";
        }
      });
    </script>
  </body>
</html>
